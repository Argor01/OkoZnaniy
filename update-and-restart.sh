#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะธ ะฟะตัะตะทะฐะฟััะบะฐ ะฟัะพะตะบัะฐ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./update-and-restart.sh

echo "๐ ะะฐัะธะฝะฐะตะผ ะพะฑะฝะพะฒะปะตะฝะธะต ะฟัะพะตะบัะฐ..."

# ะะพะปััะฐะตะผ ะฟะพัะปะตะดะฝะธะต ะธะทะผะตะฝะตะฝะธั ะธะท git
echo "๐ฅ ะะพะปััะฐะตะผ ะธะทะผะตะฝะตะฝะธั ะธะท git..."
git pull origin main

if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะฟะพะปััะตะฝะธะธ ะธะทะผะตะฝะตะฝะธะน ะธะท git"
    exit 1
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker-compose down

if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะพััะฐะฝะพะฒะบะต ะบะพะฝัะตะนะฝะตัะพะฒ"
    exit 1
fi

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ npm ะทะฐะฒะธัะธะผะพััะธ (ะตัะปะธ package.json ะธะทะผะตะฝะธะปัั)
if [ -f "frontend-react/package.json" ]; then
    echo "๐ฆ ะัะพะฒะตััะตะผ npm ะทะฐะฒะธัะธะผะพััะธ..."
    cd frontend-react
    npm install
    cd ..
fi

# ะะตัะตัะพะฑะธัะฐะตะผ ะบะพะฝัะตะนะฝะตัั ะฑะตะท ะบะตัะฐ
echo "๐จ ะะตัะตัะพะฑะธัะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker-compose build --no-cache

if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ัะฑะพัะบะต ะบะพะฝัะตะนะฝะตัะพะฒ"
    exit 1
fi

# ะะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต
echo "๐ ะะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker-compose up -d

if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะทะฐะฟััะบะต ะบะพะฝัะตะนะฝะตัะพะฒ"
    exit 1
fi

# ะะดะตะผ ะฟะพะบะฐ ะบะพะฝัะตะนะฝะตัั ะทะฐะฟััััััั
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ..."
sleep 10

# ะัะฟัะฐะฒะปัะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ
echo "๐ง ะัะฟัะฐะฒะปัะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ..."
docker-compose exec -T backend chown -R appuser:appuser /app/media /app/static 2>/dev/null || true
docker-compose exec -T backend chmod -R 755 /app/media /app/static 2>/dev/null || true

# ะัะธะผะตะฝัะตะผ ะผะธะณัะฐัะธะธ
echo "๐๏ธ ะัะธะผะตะฝัะตะผ ะผะธะณัะฐัะธะธ ะฑะฐะทั ะดะฐะฝะฝัั..."
docker-compose exec -T backend python manage.py migrate

if [ $? -ne 0 ]; then
    echo "โ๏ธ ะัะตะดัะฟัะตะถะดะตะฝะธะต: ะัะธะฑะบะฐ ะฟัะธ ะฟัะธะผะตะฝะตะฝะธะธ ะผะธะณัะฐัะธะน"
fi

# ะกะพะฑะธัะฐะตะผ ััะฐัะธัะตัะบะธะต ัะฐะนะปั
echo "๐ฆ ะกะพะฑะธัะฐะตะผ ััะฐัะธัะตัะบะธะต ัะฐะนะปั..."
docker-compose exec -T backend python manage.py collectstatic --noinput 2>/dev/null || true

echo "โ ะัะพะตะบั ััะฟะตัะฝะพ ะพะฑะฝะพะฒะปะตะฝ ะธ ะฟะตัะตะทะฐะฟััะตะฝ!"
echo "๐ ะัะพะฒะตัััะต ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ: docker-compose ps"
echo "๐ ะัะพัะผะพัั ะปะพะณะพะฒ: docker-compose logs -f"
