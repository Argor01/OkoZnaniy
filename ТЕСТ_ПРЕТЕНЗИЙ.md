# Тестирование претензий - Быстрый старт

## Проблема
Претензии от экспертов не доходят до администратора в админ-панели.

## Решение
Созданы автоматические тесты для проверки всего флоу претензий.

## Как запустить тесты

### 1. Запустите Docker
```bash
docker-compose up -d
```

### 2. Запустите тест
```bash
docker-compose exec backend python test_claim_to_admin_flow.py
```

### Что проверяет тест:
✅ Создание претензии экспертом  
✅ Появление претензии в админ-панели  
✅ Взятие претензии в работу администратором  
✅ Завершение претензии  

## Дополнительные команды

### Показать все претензии в системе
```bash
docker-compose exec backend python test_claim_to_admin_flow.py --show
```

### Тест API эндпоинтов
```bash
docker-compose exec backend python test_claim_api_endpoints.py
```

### Создать тестовую претензию
```bash
docker-compose exec backend python test_claims_creation.py --create
```

## Ручное тестирование

### Через интерфейс:

1. **Эксперт создает претензию:**
   - Войти как эксперт
   - Открыть чат поддержки
   - Нажать "Подать претензию"
   - Заполнить форму и отправить

2. **Администратор видит претензию:**
   - Войти как администратор
   - Открыть админ-панель
   - Перейти в "Новые обращения"
   - Претензия должна быть в списке

3. **Администратор обрабатывает:**
   - Нажать "Взять в работу"
   - Претензия переходит в "В работе"
   - Нажать "Завершить"
   - Ввести решение
   - Претензия переходит в "Завершенные"

### Через Django Admin:

```bash
# Откройте в браузере
http://localhost:8000/admin/

# Войдите как суперпользователь
# Перейдите в раздел "Claims"
```

### Через API:

```bash
# Получить все претензии
curl http://localhost:8000/api/admin-panel/claims/ \
  -H "Authorization: Token YOUR_TOKEN"

# Получить новые претензии
curl "http://localhost:8000/api/admin-panel/claims/?status=new" \
  -H "Authorization: Token YOUR_TOKEN"
```

## Что должно работать

### ✅ Создание претензии
- Эксперт может создать претензию
- Претензия сохраняется в БД
- Статус "new"

### ✅ Видимость в админ-панели
- Администратор видит новые претензии
- Отображаются все данные
- Можно фильтровать по статусу

### ✅ Обработка администратором
- Можно взять в работу
- Можно завершить
- Можно отклонить
- Статусы меняются корректно

### ✅ API работает
- GET /api/admin-panel/claims/
- GET /api/admin-panel/claims/?status=new
- POST /api/admin-panel/claims/{id}/take_in_work/
- POST /api/admin-panel/claims/{id}/complete_claim/

## Ожидаемый результат теста

```
======================================================================
  РЕЗУЛЬТАТ ТЕСТА
======================================================================
✅ ВСЕ ПРОВЕРКИ ПРОЙДЕНЫ УСПЕШНО!
ℹ️  Претензия #1 прошла полный цикл:
ℹ️    1. Создана экспертом test_expert_claim
ℹ️    2. Появилась в админ-панели
ℹ️    3. Взята в работу администратором test_admin_claim
ℹ️    4. Успешно завершена
```

## Если тест не проходит

### Проверьте Docker
```bash
docker-compose ps
# Все сервисы должны быть "Up"
```

### Проверьте базу данных
```bash
docker-compose exec backend python manage.py migrate
```

### Проверьте логи
```bash
docker-compose logs backend
```

### Проверьте права пользователя
```bash
docker-compose exec backend python manage.py shell

# В shell:
from django.contrib.auth import get_user_model
User = get_user_model()
admin = User.objects.get(username='ваш_админ')
print(admin.role)  # Должно быть 'admin'
```

## Файлы тестов

- `test_claim_to_admin_flow.py` - Полный тест флоу претензий
- `test_claim_api_endpoints.py` - Тест API эндпоинтов
- `test_claims_creation.py` - Создание и просмотр претензий
- `HOW_TO_TEST_CLAIM_FLOW.md` - Подробная инструкция
- `RUN_CLAIM_TESTS.md` - Инструкция по запуску

## Контакты

Если тесты не проходят или есть вопросы, проверьте:
1. Docker запущен
2. База данных доступна
3. Миграции применены
4. Пользователи имеют правильные роли
