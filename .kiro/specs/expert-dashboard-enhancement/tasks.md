# План реализации

## Этап 1: Изменения в базе данных и моделях

- [x] 1. Создать модель Notification и миграции


  - Создать модель Notification в apps/notifications/models.py с полями: recipient, type, title, message, data, is_read, created_at
  - Добавить enum NotificationType с типами уведомлений
  - Добавить Meta класс с индексами для оптимизации
  - Создать и применить миграции
  - _Требования: 9.1, 9.2, 9.3_

- [x] 2. Добавить индексы базы данных для оптимизации производительности



  - Добавить индексы в модель Order для (expert, status, -created_at), (status, subject, -created_at), (-created_at)
  - Добавить индексы в модель Transaction для (user, -timestamp), (user, type, -timestamp)
  - Добавить индексы в модель ExpertReview для (expert, is_published, -created_at)
  - Создать и применить миграции
  - _Требования: 4.3, 7.5, 8.4_

## Этап 2: Реализация слоя сервисов

- [x] 3. Реализовать ExpertStatisticsService


  - Создать метод get_dashboard_statistics() для агрегации статистики эксперта
  - Создать метод update_expert_statistics() для обновления ExpertStatistics
  - Создать метод get_earnings_by_period() для расчета заработка за период
  - Добавить кэширование статистики с таймаутом 5 минут
  - _Требования: 1.1, 1.2, 1.3_

- [x] 4. Реализовать ExpertFinanceService

  - Создать метод get_financial_summary() для расчета баланса, заработка и выплат
  - Создать метод get_transactions() с поддержкой фильтрации
  - Создать метод calculate_pending_payouts()
  - Создать метод get_last_payout()
  - _Требования: 7.1, 7.2, 7.3, 7.4_


- [ ] 5. Реализовать ExpertOrderService
  - Создать метод get_available_orders() с фильтрацией по специализациям и оптимизацией запросов
  - Создать метод get_active_orders() с оптимизацией через select_related
  - Создать метод take_order() с валидацией и отправкой уведомлений
  - Создать метод can_take_order() для проверки возможности взятия заказа
  - _Требования: 3.1, 3.2, 4.1, 6.1, 6.2_

## Этап 3: Реализация сериализаторов

- [x] 6. Создать новые сериализаторы


  - Создать TransactionSerializer с полями order_info и type_display
  - Создать NotificationSerializer с полем type_display
  - Создать ExpertReviewDetailSerializer с информацией о клиенте и заказе
  - Добавить валидацию в сериализаторы
  - _Требования: 7.2, 8.1, 9.3_

## Этап 4: Реализация API эндпоинтов

- [x] 7. Расширить ExpertDashboardViewSet финансовыми эндпоинтами


  - Реализовать action financial_summary() для возврата баланса, заработка и информации о выплатах
  - Реализовать action transactions() с фильтрацией по типу и диапазону дат
  - Добавить поддержку пагинации для транзакций
  - Добавить проверку прав доступа для роли эксперта
  - _Требования: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 8. Расширить ExpertDashboardViewSet эндпоинтами для отзывов и уведомлений


  - Реализовать action reviews() с фильтром по рейтингу и пагинацией
  - Вычислять average_rating и rating_distribution
  - Реализовать action notifications() с фильтрами unread_only и type
  - Реализовать action mark_notification_read()
  - Добавить проверки прав доступа
  - _Требования: 8.1, 8.2, 8.3, 9.1, 9.3, 9.4, 9.5_


- [x] 9. Обновить существующие методы ExpertDashboardViewSet

  - Рефакторить statistics() для использования ExpertStatisticsService
  - Рефакторить available_orders() для использования ExpertOrderService
  - Рефакторить active_orders() для использования ExpertOrderService
  - Рефакторить take_order() для использования ExpertOrderService
  - Добавить оптимизацию запросов через select_related и prefetch_related
  - _Требования: 1.1, 3.1, 4.1, 6.1_

## Этап 5: Интеграция системы уведомлений

- [x] 10. Расширить NotificationService


  - Добавить метод notify_new_order() для уведомлений о новых заказах по специализациям
  - Добавить метод notify_payment_received() для уведомлений о платежах
  - Обновить существующие методы уведомлений для создания экземпляров модели Notification
  - Добавить массовое создание уведомлений для нескольких экспертов
  - _Требования: 9.1, 9.2_

## Этап 6: Маршрутизация URL и конфигурация

- [x] 11. Обновить маршрутизацию URL


  - Добавить маршруты для новых эндпоинтов дашборда в apps/experts/urls.py
  - Проверить правильность регистрации всех эндпоинтов
  - Протестировать URL паттерны
  - _Требования: Все API эндпоинты_

## Этап 7: Тестирование

- [ ]* 12. Написать unit-тесты для сервисов
  - Тестировать методы ExpertStatisticsService
  - Тестировать методы ExpertFinanceService
  - Тестировать методы ExpertOrderService
  - Тестировать граничные случаи и обработку ошибок
  - _Требования: Все требования слоя сервисов_

- [ ]* 13. Написать интеграционные тесты для API эндпоинтов
  - Тестировать все эндпоинты ExpertDashboardViewSet
  - Тестировать аутентификацию и авторизацию
  - Тестировать фильтрацию и пагинацию
  - Тестировать ответы с ошибками
  - _Требования: Все API требования_

- [ ]* 14. Написать тесты производительности
  - Тестировать количество запросов для эндпоинта available_orders (макс 3 запроса)
  - Тестировать время ответа для эндпоинта statistics (< 500ms)
  - Тестировать производительность пагинации с большими наборами данных
  - _Требования: 3.1, 4.3_

## Этап 8: Оптимизация и доработка

- [x] 15. Реализовать стратегию кэширования


  - Добавить Redis кэширование для статистики дашборда
  - Добавить кэширование данных профиля эксперта
  - Установить подходящие таймауты кэша
  - Добавить инвалидацию кэша при обновлении данных
  - _Требования: 1.3_

- [x] 16. Добавить обработку ошибок и логирование



  - Добавить блоки try-except во все методы ViewSet
  - Добавить логирование важных операций
  - Добавить кастомные сообщения об ошибках
  - Протестировать сценарии с ошибками
  - _Требования: Все требования_

## Этап 9: Документация

- [ ]* 17. Обновить API документацию
  - Добавить docstring'и ко всем новым методам
  - Сгенерировать OpenAPI схему с помощью drf-spectacular
  - Создать примеры использования API
  - Документировать query параметры и форматы ответов
  - _Требования: Все API требования_

## Этап 10: Подготовка к развертыванию

- [ ]* 18. Подготовиться к развертыванию
  - Запустить все миграции на staging
  - Проверить прохождение всех тестов
  - Проверить на уязвимости безопасности
  - Обновить requirements.txt при необходимости
  - Создать чеклист развертывания
  - _Требования: Все требования_
