# Техническая спецификация: Личный кабинет менеджера по работе с клиентами (Арбитраж)

## Оглавление
1. [Общее описание](#общее-описание)
2. [Функциональные требования](#функциональные-требования)
3. [Этапы разработки](#этапы-разработки)
4. [Структура компонентов](#структура-компонентов)
5. [API эндпоинты](#api-эндпоинты)
6. [Типы данных](#типы-данных)
7. [UI/UX требования](#uiux-требования)

---

## Общее описание

Личный кабинет менеджера по работе с клиентами (арбитража) предназначен для обработки претензий, рассмотрения спорных ситуаций между клиентами и экспертами, принятия решений по возвратам средств и управления коммуникацией с дирекцией.

### Основные возможности:
- **Обработка претензий**: Рассмотрение заявок на возврат средств, работа с отменёнными обращениями, принятие решений по спорным ситуациям
- **Внутренняя коммуникация**: Прямой чат с дирекцией для согласования сложных случаев
- **Панель навигации**: Управление обращениями по статусам (новые, в работе, завершённые, ожидают решения)

---

## Функциональные требования

### 1. Обработка претензий

#### 1.1. Рассмотрение заявок на возврат средств
- Просмотр списка заявок на возврат средств
- Фильтрация заявок по статусу, дате создания, сумме
- Детальный просмотр заявки с информацией о заказе, клиенте, эксперте
- История коммуникации между клиентом и экспертом
- Прикрепленные файлы и документы
- Принятие решения: одобрить возврат, отклонить, запросить дополнительную информацию

#### 1.2. Работа с отменёнными обращениями (арбитраж, конфликты)
- Просмотр отменённых заказов, требующих арбитража
- Фильтрация по типу конфликта (качество работы, нарушение сроков, другие)
- Детальная информация о конфликте
- История изменений статуса заказа
- Комментарии и жалобы от обеих сторон
- Возможность запросить дополнительную информацию у сторон

#### 1.3. Принятие итогового решения по спорной ситуации
- Форма принятия решения с обоснованием
- Выбор варианта решения:
  - Полный возврат средств клиенту
  - Частичный возврат средств
  - Отказ в возврате
  - Возврат заказа на доработку эксперту
  - Другие варианты (настраиваемые)
- Уведомление всех участников о решении
- Автоматическое обновление статусов заказа и платежей

### 2. Внутренняя коммуникация

#### 2.1. Прямой чат с дирекцией
- Отправка сообщений дирекции для согласования сложных случаев
- Прикрепление файлов и документов к сообщениям
- История переписки с дирекцией
- Статусы сообщений (отправлено, прочитано, ответ получен)
- Возможность отметить обращение как "требует согласования"
- Уведомления о новых сообщениях от дирекции

### 3. Панель навигации

#### 3.1. Новые обращения
- Список новых обращений, требующих обработки
- Сортировка по приоритету, дате создания, сумме
- Быстрый просмотр основной информации
- Возможность взять обращение в работу
- Количество непрочитанных обращений

#### 3.2. В работе
- Список обращений, находящихся в обработке
- Фильтрация по арбитру (если несколько арбитров)
- Отображение времени, прошедшего с начала обработки
- Статус каждого обращения (ожидает ответа, требует согласования, др.)
- Возможность перевести обращение в другой статус

#### 3.3. Завершённые
- Архив завершённых обращений
- Фильтрация по периоду, типу решения, арбитру
- Статистика по завершённым обращениям
- Экспорт данных в Excel/PDF
- Детальный просмотр решений

#### 3.4. Ожидают решения
- Обращения, отправленные на согласование дирекции
- Статус согласования (отправлено, в рассмотрении, согласовано, отклонено)
- Возможность отменить запрос на согласование
- Комментарии от дирекции

---

## Этапы разработки

### Этап 1: Базовая структура и настройка проекта (1 день)

#### 1.1. Создание структуры компонентов
- Создание директории `src/pages/ArbitratorDashboard/`
- Создание поддиректорий для компонентов:
  - `components/ClaimsProcessing/` - обработка претензий
  - `components/InternalCommunication/` - внутренняя коммуникация
  - `components/NavigationPanel/` - панель навигации
  - `api/` - API функции и типы

#### 1.2. Настройка маршрутизации
- Добавление маршрута `/arbitrator` в `App.tsx`
- Настройка защищённого маршрута с проверкой роли `arbitrator`
- Интеграция с существующей системой аутентификации

#### 1.3. Базовый layout
- Создание основного компонента `ArbitratorDashboard.tsx`
- Реализация структуры layout:
  - Header с информацией о пользователе и кнопкой выхода
  - Sidebar с навигацией по разделам
  - Content area для отображения выбранного раздела
  - Footer (опционально)

#### 1.4. API клиент и типы
- Создание файла `api/types.ts` с типами данных
- Создание файла `api/arbitratorApi.ts` с stub функциями для API
- Определение интерфейсов для:
  - Claim (претензия)
  - RefundRequest (заявка на возврат)
  - Dispute (спор)
  - InternalMessage (внутреннее сообщение)
  - Decision (решение)

---

### Этап 2: Панель навигации (1 день)

#### 2.1. Компонент NavigationPanel
- Создание компонента `NavigationPanel.tsx`
- Реализация вкладок/меню:
  - Новые обращения
  - В работе
  - Завершённые
  - Ожидают решения

#### 2.2. Компонент NewClaims
- Создание компонента `NewClaims.tsx`
- Таблица со списком новых обращений
- Колонки:
  - Номер обращения
  - Тип (возврат средств, арбитраж, конфликт)
  - Клиент
  - Эксперт
  - Сумма
  - Дата создания
  - Приоритет
  - Действия (просмотр, взять в работу)
- Фильтры и сортировка
- Поиск по номеру обращения, клиенту, эксперту

#### 2.3. Компонент InProgress
- Создание компонента `InProgress.tsx`
- Таблица со списком обращений в работе
- Колонки:
  - Номер обращения
  - Тип
  - Клиент
  - Эксперт
  - Статус
  - Время в работе
  - Последнее действие
  - Действия (продолжить, отправить на согласование, завершить)
- Фильтры по статусу, арбитру, периоду

#### 2.4. Компонент Completed
- Создание компонента `Completed.tsx`
- Таблица со списком завершённых обращений
- Колонки:
  - Номер обращения
  - Тип
  - Клиент
  - Эксперт
  - Решение
  - Дата завершения
  - Арбитр
  - Действия (просмотр деталей, экспорт)
- Фильтры по периоду, типу решения, арбитру
- Экспорт в Excel/PDF

#### 2.5. Компонент PendingApproval
- Создание компонента `PendingApproval.tsx`
- Таблица со списком обращений, ожидающих решения дирекции
- Колонки:
  - Номер обращения
  - Тип
  - Клиент
  - Эксперт
  - Дата отправки
  - Статус согласования
  - Комментарий
  - Действия (просмотр, отменить запрос)
- Фильтры по статусу согласования, периоду

---

### Этап 3: Обработка претензий (2 дня)

#### 3.1. Компонент ClaimsProcessing
- Создание основного компонента `ClaimsProcessing.tsx`
- Интеграция с панелью навигации
- Переключение между подразделами:
  - Заявки на возврат средств
  - Отменённые обращения
  - Принятие решений

#### 3.2. Компонент RefundRequests
- Создание компонента `RefundRequests.tsx`
- Таблица со списком заявок на возврат средств
- Фильтры:
  - По статусу (новая, в рассмотрении, одобрена, отклонена)
  - По сумме (диапазон)
  - По дате создания
  - По клиенту/эксперту
- Детальный просмотр заявки:
  - Информация о заказе (номер, название, описание, сроки)
  - Информация о клиенте (имя, email, телефон)
  - Информация об эксперте (имя, email, рейтинг)
  - История коммуникации (комментарии, сообщения)
  - Прикрепленные файлы
  - История изменений статуса
  - Форма принятия решения

#### 3.3. Компонент CancelledOrders
- Создание компонента `CancelledOrders.tsx`
- Таблица со списком отменённых заказов, требующих арбитража
- Фильтры:
  - По типу конфликта (качество работы, нарушение сроков, другие)
  - По статусу (новая, в рассмотрении, решена)
  - По дате отмены
  - По клиенту/эксперту
- Детальный просмотр конфликта:
  - Информация о заказе
  - Причина отмены (от клиента, от эксперта, автоматическая)
  - Жалобы и комментарии от обеих сторон
  - История изменений статуса заказа
  - Прикрепленные файлы (работы, доказательства)
  - Форма запроса дополнительной информации
  - Форма принятия решения

#### 3.4. Компонент DecisionForm
- Создание компонента `DecisionForm.tsx`
- Форма для принятия решения по спорной ситуации
- Поля формы:
  - Тип решения (выпадающий список):
    - Полный возврат средств клиенту
    - Частичный возврат средств (с указанием суммы)
    - Отказ в возврате
    - Возврат заказа на доработку эксперту
    - Другие варианты
  - Обоснование решения (текстовое поле, обязательное)
  - Комментарий для клиента (текстовое поле, опционально)
  - Комментарий для эксперта (текстовое поле, опционально)
  - Требуется согласование дирекции (чекбокс)
  - Прикрепленные файлы (опционально)
- Валидация формы
- Отправка решения на сервер
- Обработка успешного/неуспешного ответа

#### 3.5. Компонент ClaimDetails
- Создание компонента `ClaimDetails.tsx`
- Детальный просмотр обращения/претензии
- Разделы:
  - Основная информация (номер, тип, статус, даты)
  - Информация о заказе
  - Информация о клиенте
  - Информация об эксперте
  - История коммуникации
  - История изменений статуса
  - Прикрепленные файлы
  - Форма принятия решения
- Возможность запросить дополнительную информацию
- Возможность отправить на согласование дирекции

---

### Этап 4: Внутренняя коммуникация (1 день)

#### 4.1. Компонент InternalCommunication
- Создание основного компонента `InternalCommunication.tsx`
- Интеграция с панелью навигации
- Структура:
  - Список обращений, отправленных на согласование
  - Чат с дирекцией

#### 4.2. Компонент DirectorChat
- Создание компонента `DirectorChat.tsx`
- Интерфейс чата с дирекцией:
  - Список сообщений (хронологический порядок)
  - Форма отправки нового сообщения:
    - Текст сообщения
    - Прикрепление файлов
    - Связь с обращением (выбор из списка)
  - Статусы сообщений (отправлено, прочитано, ответ получен)
  - Уведомления о новых сообщениях
- Фильтрация сообщений по обращению
- Поиск по тексту сообщений
- Пагинация сообщений

#### 4.3. Компонент MessageList
- Создание компонента `MessageList.tsx`
- Список сообщений с дирекцией
- Отображение:
  - Отправитель (арбитр или дирекция)
  - Текст сообщения
  - Дата и время отправки
  - Статус прочтения
  - Связанное обращение
  - Прикрепленные файлы
- Возможность ответить на сообщение
- Возможность удалить сообщение (только свои)

#### 4.4. Компонент MessageForm
- Создание компонента `MessageForm.tsx`
- Форма отправки сообщения дирекции
- Поля:
  - Текст сообщения (обязательное)
  - Связь с обращением (выпадающий список, опционально)
  - Прикрепленные файлы (опционально)
  - Приоритет (низкий, средний, высокий, опционально)
- Валидация формы
- Отправка сообщения на сервер
- Обработка успешного/неуспешного ответа

---

### Этап 5: Дополнительные функции и улучшения (1 день)

#### 5.1. Статистика и аналитика
- Создание компонента `Statistics.tsx`
- Отображение статистики:
  - Общее количество обращений
  - Количество обращений по статусам
  - Среднее время обработки обращения
  - Количество решений по типам
  - Графики и диаграммы (по периодам, типам решений)
- Фильтры по периоду
- Экспорт статистики

#### 5.2. Уведомления
- Реализация системы уведомлений:
  - Новые обращения
  - Ответы от дирекции
  - Изменения статуса обращений
  - Напоминания о просроченных обращениях
- Отображение уведомлений в header
- Настройка уведомлений (какие получать)

#### 5.3. Фильтры и поиск
- Улучшение фильтров во всех компонентах
- Глобальный поиск по всем обращениям
- Сохранение фильтров в localStorage
- Экспорт отфильтрованных данных

#### 5.4. Экспорт данных
- Реализация экспорта в Excel
- Реализация экспорта в PDF
- Настройка экспортируемых полей
- Экспорт выбранных записей или всех

---

## Структура компонентов

```
src/pages/ArbitratorDashboard/
├── ArbitratorDashboard.tsx          # Основной компонент
├── api/
│   ├── arbitratorApi.ts             # API функции
│   └── types.ts                     # TypeScript типы
├── components/
│   ├── ClaimsProcessing/
│   │   ├── ClaimsProcessing.tsx     # Основной компонент обработки претензий
│   │   ├── RefundRequests.tsx       # Заявки на возврат средств
│   │   ├── CancelledOrders.tsx      # Отменённые обращения
│   │   ├── DecisionForm.tsx         # Форма принятия решения
│   │   └── ClaimDetails.tsx         # Детальный просмотр обращения
│   ├── InternalCommunication/
│   │   ├── InternalCommunication.tsx # Основной компонент коммуникации
│   │   ├── DirectorChat.tsx         # Чат с дирекцией
│   │   ├── MessageList.tsx          # Список сообщений
│   │   └── MessageForm.tsx          # Форма отправки сообщения
│   ├── NavigationPanel/
│   │   ├── NavigationPanel.tsx      # Панель навигации
│   │   ├── NewClaims.tsx            # Новые обращения
│   │   ├── InProgress.tsx           # В работе
│   │   ├── Completed.tsx            # Завершённые
│   │   └── PendingApproval.tsx      # Ожидают решения
│   └── Statistics/
│       └── Statistics.tsx           # Статистика и аналитика
```

---

## API эндпоинты

### Претензии и обращения

#### GET /api/arbitrator/claims/
- Получение списка претензий/обращений
- Параметры запроса:
  - `status` - фильтр по статусу (new, in_progress, completed, pending_approval)
  - `type` - фильтр по типу (refund, dispute, conflict)
  - `page` - номер страницы
  - `page_size` - размер страницы
  - `search` - поисковый запрос
  - `date_from` - дата начала периода
  - `date_to` - дата конца периода

#### GET /api/arbitrator/claims/{id}/
- Получение детальной информации о претензии/обращении

#### POST /api/arbitrator/claims/{id}/take/
- Взять претензию/обращение в работу

#### POST /api/arbitrator/claims/{id}/decision/
- Принять решение по претензии/обращению
- Тело запроса:
  - `decision_type` - тип решения
  - `reasoning` - обоснование
  - `client_comment` - комментарий для клиента (опционально)
  - `expert_comment` - комментарий для эксперта (опционально)
  - `require_approval` - требуется согласование дирекции (булево)
  - `refund_amount` - сумма возврата (если частичный возврат)

#### POST /api/arbitrator/claims/{id}/request-info/
- Запросить дополнительную информацию
- Тело запроса:
  - `message` - текст запроса
  - `recipient` - получатель (client, expert, both)

#### POST /api/arbitrator/claims/{id}/send-for-approval/
- Отправить на согласование дирекции
- Тело запроса:
  - `message` - сообщение дирекции

### Внутренняя коммуникация

#### GET /api/arbitrator/messages/
- Получение списка сообщений с дирекцией
- Параметры запроса:
  - `page` - номер страницы
  - `page_size` - размер страницы
  - `claim_id` - фильтр по обращению
  - `unread_only` - только непрочитанные (булево)

#### POST /api/arbitrator/messages/
- Отправка сообщения дирекции
- Тело запроса:
  - `text` - текст сообщения
  - `claim_id` - связанное обращение (опционально)
  - `priority` - приоритет (low, medium, high, опционально)
  - `attachments` - прикрепленные файлы (опционально)

#### GET /api/arbitrator/messages/{id}/
- Получение детальной информации о сообщении

#### POST /api/arbitrator/messages/{id}/read/
- Отметить сообщение как прочитанное

#### DELETE /api/arbitrator/messages/{id}/
- Удалить сообщение (только свои)

### Статистика

#### GET /api/arbitrator/statistics/
- Получение статистики
- Параметры запроса:
  - `date_from` - дата начала периода
  - `date_to` - дата конца периода

---

## Типы данных

### Claim (Претензия/Обращение)
```typescript
interface Claim {
  id: number;
  type: 'refund' | 'dispute' | 'conflict';
  status: 'new' | 'in_progress' | 'completed' | 'pending_approval';
  priority: 'low' | 'medium' | 'high';
  order: {
    id: number;
    title: string;
    description: string;
    amount: number;
    created_at: string;
    deadline: string;
    status: string;
  };
  client: {
    id: number;
    username: string;
    email: string;
    phone?: string;
  };
  expert: {
    id: number;
    username: string;
    email: string;
    rating?: number;
  };
  created_at: string;
  updated_at: string;
  taken_at?: string;
  completed_at?: string;
  arbitrator?: {
    id: number;
    username: string;
  };
  decision?: Decision;
  messages: Message[];
  attachments: Attachment[];
}
```

### RefundRequest (Заявка на возврат средств)
```typescript
interface RefundRequest extends Claim {
  type: 'refund';
  requested_amount: number;
  reason: string;
  client_comments: string;
  expert_response?: string;
}
```

### Dispute (Спор)
```typescript
interface Dispute extends Claim {
  type: 'dispute' | 'conflict';
  conflict_type: 'quality' | 'deadline' | 'other';
  cancellation_reason: string;
  client_complaint: string;
  expert_complaint?: string;
}
```

### Decision (Решение)
```typescript
interface Decision {
  id: number;
  claim_id: number;
  decision_type: 'full_refund' | 'partial_refund' | 'no_refund' | 'revision' | 'other';
  refund_amount?: number;
  reasoning: string;
  client_comment?: string;
  expert_comment?: string;
  created_at: string;
  arbitrator: {
    id: number;
    username: string;
  };
  requires_approval: boolean;
  approval_status?: 'pending' | 'approved' | 'rejected';
  approval_comment?: string;
}
```

### InternalMessage (Внутреннее сообщение)
```typescript
interface InternalMessage {
  id: number;
  sender: {
    id: number;
    username: string;
    role: string;
  };
  recipient: {
    id: number;
    username: string;
    role: string;
  };
  text: string;
  claim_id?: number;
  priority: 'low' | 'medium' | 'high';
  attachments: Attachment[];
  created_at: string;
  read_at?: string;
  status: 'sent' | 'read' | 'replied';
}
```

### Attachment (Вложение)
```typescript
interface Attachment {
  id: number;
  name: string;
  url: string;
  size: number;
  file_type: string;
  uploaded_at: string;
}
```

---

## UI/UX требования

### Общие требования
- Адаптивный дизайн для десктопа и планшетов
- Использование Ant Design 5+ для компонентов
- Единый стиль с остальным приложением
- Поддержка темной темы (опционально)

### Цветовая схема
- Новые обращения: синий (blue)
- В работе: оранжевый (orange)
- Завершённые: зелёный (green)
- Ожидают решения: фиолетовый (purple)
- Высокий приоритет: красный (red)
- Средний приоритет: оранжевый (orange)
- Низкий приоритет: серый (gray)

### Компоненты интерфейса
- Таблицы с пагинацией и сортировкой
- Модальные окна для детального просмотра и форм
- Карточки для отображения статистики
- Формы с валидацией
- Уведомления (toast messages)
- Индикаторы загрузки (spinners)
- Пустые состояния (empty states)

### Интерактивность
- Фильтры с сохранением состояния
- Поиск в реальном времени
- Автообновление данных (опционально, с настройкой интервала)
- Клавиатурные сокращения для частых действий
- Подтверждение критических действий (модальные окна)

### Производительность
- Ленивая загрузка данных (пагинация)
- Оптимизация рендеринга больших списков (виртуализация, опционально)
- Кэширование данных с помощью React Query
- Оптимистичные обновления UI

---

## Дополнительные замечания

### Безопасность
- Проверка прав доступа на уровне API
- Валидация всех входных данных
- Защита от XSS и CSRF атак
- Логирование всех действий арбитра

### Тестирование
- Unit тесты для компонентов
- Integration тесты для API
- E2E тесты для критических сценариев
- Тестирование на разных браузерах

### Документация
- Комментарии в коде
- README для компонентов
- Документация API
- Руководство пользователя

### Масштабируемость
- Поддержка нескольких арбитров
- Распределение нагрузки между арбитрами
- Мониторинг производительности
- Оптимизация запросов к базе данных

---

## Порядок разработки (краткое резюме)

1. **Этап 1**: Базовая структура и настройка проекта (1 день)
2. **Этап 2**: Панель навигации (1 день)
3. **Этап 3**: Обработка претензий (2 дня)
4. **Этап 4**: Внутренняя коммуникация (1 день)
5. **Этап 5**: Дополнительные функции и улучшения (1 день)

**Общее время разработки**: ~6 рабочих дней

---

## Заключение

Данная спецификация описывает полный функционал личного кабинета менеджера по работе с клиентами (арбитража). Разработка должна вестись поэтапно, с тестированием каждого этапа перед переходом к следующему. При необходимости спецификация может быть дополнена или изменена в процессе разработки.

