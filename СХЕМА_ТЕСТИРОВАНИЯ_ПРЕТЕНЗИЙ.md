# Схема тестирования претензий

## 📊 Визуальная схема флоу

```
┌─────────────────────────────────────────────────────────────────┐
│                    ФЛОУ ПРЕТЕНЗИЙ                                │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐
│   ЭКСПЕРТ    │
└──────┬───────┘
       │
       │ 1. Открывает чат
       ▼
┌─────────────────────────┐
│  Кнопка "Подать         │
│  претензию"             │
└──────────┬──────────────┘
           │
           │ 2. Заполняет форму
           ▼
┌─────────────────────────────────┐
│  Форма претензии:               │
│  • Тип (качество/возврат/др.)   │
│  • Тема                         │
│  • Описание                     │
│  • Заказ (опционально)          │
└──────────┬──────────────────────┘
           │
           │ 3. Отправляет
           ▼
┌─────────────────────────┐
│  POST /api/admin-panel/ │
│  claims/                │
│  → 201 Created          │
└──────────┬──────────────┘
           │
           │ 4. Сохраняется в БД
           ▼
┌─────────────────────────┐
│  База данных            │
│  Claim (status='new')   │
└──────────┬──────────────┘
           │
           │ 5. Доступна администратору
           ▼
┌──────────────────────────────────────────┐
│         АДМИН-ПАНЕЛЬ                     │
│  ┌────────────────────────────────────┐  │
│  │  Новые обращения (New Claims)     │  │
│  │  ┌──────────────────────────────┐ │  │
│  │  │ ID | Пользователь | Тип     │ │  │
│  │  │ #1 | test_expert  | Качество│ │  │
│  │  │    | Тема: Тест претензии    │ │  │
│  │  │    | [Взять в работу]        │ │  │
│  │  └──────────────────────────────┘ │  │
│  └────────────────────────────────────┘  │
└──────────────┬───────────────────────────┘
               │
               │ 6. Администратор берет в работу
               ▼
┌─────────────────────────┐
│  POST /api/admin-panel/ │
│  claims/1/take_in_work/ │
│  → 200 OK               │
└──────────┬──────────────┘
           │
           │ 7. Статус меняется
           ▼
┌─────────────────────────┐
│  База данных            │
│  Claim (status=         │
│  'in_progress')         │
│  admin=test_admin       │
└──────────┬──────────────┘
           │
           │ 8. Перемещается в раздел
           ▼
┌──────────────────────────────────────────┐
│         АДМИН-ПАНЕЛЬ                     │
│  ┌────────────────────────────────────┐  │
│  │  Обращения в работе                │  │
│  │  ┌──────────────────────────────┐ │  │
│  │  │ #1 | test_expert             │ │  │
│  │  │    | Администратор:          │ │  │
│  │  │    | test_admin              │ │  │
│  │  │    | [Завершить] [Сообщение] │ │  │
│  │  └──────────────────────────────┘ │  │
│  └────────────────────────────────────┘  │
└──────────────┬───────────────────────────┘
               │
               │ 9. Администратор завершает
               ▼
┌─────────────────────────┐
│  POST /api/admin-panel/ │
│  claims/1/complete_     │
│  claim/                 │
│  → 200 OK               │
└──────────┬──────────────┘
           │
           │ 10. Статус меняется
           ▼
┌─────────────────────────┐
│  База данных            │
│  Claim (status=         │
│  'completed')           │
│  resolution="..."       │
│  completed_at=now()     │
└──────────┬──────────────┘
           │
           │ 11. Перемещается в раздел
           ▼
┌──────────────────────────────────────────┐
│         АДМИН-ПАНЕЛЬ                     │
│  ┌────────────────────────────────────┐  │
│  │  Завершенные обращения             │  │
│  │  ┌──────────────────────────────┐ │  │
│  │  │ #1 | test_expert             │ │  │
│  │  │    | Решение: Проблема       │ │  │
│  │  │    | решена                  │ │  │
│  │  │    | Завершено: 14.02.2026   │ │  │
│  │  └──────────────────────────────┘ │  │
│  └────────────────────────────────────┘  │
└───────────────────────────────────────────┘
```

---

## 🔄 Диаграмма состояний

```
┌─────────┐
│   NEW   │ ◄─── Создана экспертом
└────┬────┘
     │
     │ take_in_work()
     ▼
┌──────────────┐
│ IN_PROGRESS  │ ◄─── Взята администратором
└────┬─────────┘
     │
     ├─── complete_claim() ──► ┌───────────┐
     │                          │ COMPLETED │
     │                          └───────────┘
     │
     └─── reject_claim() ─────► ┌──────────┐
                                 │ REJECTED │
                                 └──────────┘
```

---

## 🗂️ Структура данных

### Претензия (Claim)

```json
{
  "id": 1,
  "user": {
    "id": 2,
    "username": "test_expert",
    "email": "expert@test.com",
    "role": "expert"
  },
  "claim_type": "quality",
  "subject": "Проблема с оплатой",
  "description": "Клиент не оплатил работу...",
  "status": "new",
  "order": {
    "id": 5,
    "title": "Курсовая работа"
  },
  "admin": null,
  "resolution": null,
  "created_at": "2026-02-14T10:30:00Z",
  "updated_at": "2026-02-14T10:30:00Z",
  "completed_at": null
}
```

---

## 🎭 Роли и права

```
┌──────────────────────────────────────────────────────┐
│                    РОЛИ                              │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ЭКСПЕРТ (expert)                                    │
│  ✅ Создавать претензии                              │
│  ✅ Просматривать свои претензии                     │
│  ✅ Отправлять сообщения в претензии                 │
│  ❌ Видеть чужие претензии                           │
│  ❌ Менять статус претензий                          │
│                                                      │
├──────────────────────────────────────────────────────┤
│                                                      │
│  АДМИНИСТРАТОР (admin)                               │
│  ✅ Видеть все претензии                             │
│  ✅ Брать претензии в работу                         │
│  ✅ Завершать претензии                              │
│  ✅ Отклонять претензии                              │
│  ✅ Отправлять сообщения                             │
│  ✅ Назначать другим администраторам                 │
│                                                      │
├──────────────────────────────────────────────────────┤
│                                                      │
│  КЛИЕНТ (client)                                     │
│  ✅ Создавать претензии                              │
│  ✅ Просматривать свои претензии                     │
│  ❌ Видеть чужие претензии                           │
│                                                      │
└──────────────────────────────────────────────────────┘
```

---

## 📍 Точки проверки

### 1️⃣ Создание претензии

```
ПРОВЕРИТЬ:
├─ Форма открывается
├─ Все поля доступны
├─ Валидация работает
├─ API запрос: POST /api/admin-panel/claims/
├─ Ответ: 201 Created
├─ Уведомление об успехе
└─ Нет ошибок в консоли
```

### 2️⃣ Отображение в админ-панели

```
ПРОВЕРИТЬ:
├─ Претензия в списке "Новые обращения"
├─ API запрос: GET /api/admin-panel/claims/?status=new
├─ Ответ: 200 OK
├─ Все данные корректны
│  ├─ ID
│  ├─ Пользователь
│  ├─ Тип
│  ├─ Тема
│  ├─ Статус
│  └─ Дата
├─ Можно открыть детали
└─ Фильтры работают
```

### 3️⃣ Взятие в работу

```
ПРОВЕРИТЬ:
├─ Кнопка "Взять в работу" доступна
├─ API запрос: POST /api/admin-panel/claims/1/take_in_work/
├─ Ответ: 200 OK
├─ Статус меняется на "in_progress"
├─ Администратор назначается
├─ Претензия перемещается в "В работе"
└─ Уведомление об успехе
```

### 4️⃣ Завершение

```
ПРОВЕРИТЬ:
├─ Кнопка "Завершить" доступна
├─ Форма решения открывается
├─ API запрос: POST /api/admin-panel/claims/1/complete_claim/
├─ Ответ: 200 OK
├─ Статус меняется на "completed"
├─ Решение сохраняется
├─ Дата завершения фиксируется
├─ Претензия перемещается в "Завершенные"
└─ Уведомление об успехе
```

---

## 🧪 Тестовые сценарии

### Сценарий 1: Успешный флоу
```
1. Эксперт создает претензию ✅
2. Претензия появляется в админ-панели ✅
3. Администратор берет в работу ✅
4. Администратор завершает ✅
5. Эксперт получает уведомление ✅
```

### Сценарий 2: Отклонение претензии
```
1. Эксперт создает претензию ✅
2. Администратор берет в работу ✅
3. Администратор отклоняет ✅
4. Претензия перемещается в "Завершенные" ✅
5. Эксперт получает уведомление ✅
```

### Сценарий 3: Несколько администраторов
```
1. Эксперт создает претензию ✅
2. Админ1 берет в работу ✅
3. Админ2 не может взять (уже в работе) ✅
4. Админ1 завершает ✅
```

### Сценарий 4: Фильтрация
```
1. Создано 5 претензий разных типов ✅
2. Фильтр по типу "Качество" → 2 претензии ✅
3. Фильтр по статусу "Новые" → 3 претензии ✅
4. Поиск по теме → 1 претензия ✅
```

---

## 🔧 Инструменты для тестирования

### Автоматические тесты (Backend)
```bash
# Полный тест флоу
python test_claim_to_admin_flow.py

# Тест API
python test_claim_api_endpoints.py

# Просмотр претензий
python test_claims_creation.py --show
```

### Ручное тестирование (Frontend)
```
1. Откройте http://localhost:5173
2. Войдите как эксперт
3. Создайте претензию
4. Войдите как администратор
5. Обработайте претензию
```

### DevTools (Browser)
```
F12 → Network → Проверьте запросы
F12 → Console → Проверьте ошибки
F12 → Application → Проверьте localStorage
```

---

## 📊 Метрики успеха

```
✅ 100% претензий создаются успешно
✅ 100% претензий видны администратору
✅ 100% претензий можно обработать
✅ 0% ошибок в консоли
✅ 0% ошибок API (404, 500)
✅ < 2 сек время отклика API
```

---

## 🎯 Быстрая проверка

```bash
# 1. Создайте тестовые данные
docker-compose exec backend python test_claim_to_admin_flow.py

# 2. Откройте браузер
http://localhost:5173

# 3. Проверьте как эксперт
Login: test_expert / test123
Создайте претензию

# 4. Проверьте как администратор
Login: test_admin / test123
Обработайте претензию

# 5. Проверьте результат
docker-compose exec backend python test_claims_creation.py
```

**Если все шаги прошли успешно - система работает! 🎉**
