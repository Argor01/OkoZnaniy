# Как протестировать прокидывание претензий в админ-панель

## Проблема
Претензии, созданные экспертами, не доходят до администратора в админ-панели.

## Что было исправлено
Добавлена проверка полного флоу претензий от создания до обработки администратором.

## Тесты

### 1. Тест полного флоу претензий (test_claim_to_admin_flow.py)

Проверяет весь жизненный цикл претензии:
- Создание тестовых пользователей (эксперт, администратор, клиент)
- Создание заказа
- Создание претензии экспертом
- Проверка видимости претензии в админ-панели
- Взятие претензии в работу администратором
- Завершение претензии

**Запуск:**
```bash
python test_claim_to_admin_flow.py
```

**Опции:**
```bash
# Показать все претензии в системе
python test_claim_to_admin_flow.py --show

# Запустить полный тест
python test_claim_to_admin_flow.py --test
```

### 2. Тест API эндпоинтов (test_claim_api_endpoints.py)

Проверяет работу API для претензий:
- GET /api/admin-panel/claims/ - получение всех претензий
- GET /api/admin-panel/claims/?status=new - получение новых претензий
- POST /api/admin-panel/claims/{id}/take_in_work/ - взятие в работу
- POST /api/admin-panel/claims/{id}/complete_claim/ - завершение претензии
- GET /api/admin-panel/stats/ - статистика

**Запуск:**
```bash
python test_claim_api_endpoints.py
```

## Ручное тестирование

### Шаг 1: Создание претензии экспертом

1. Войдите в систему как эксперт
2. Откройте чат с технической поддержкой или по заказу
3. Нажмите кнопку "Подать претензию" (красная иконка)
4. Заполните форму:
   - Тип претензии (жалоба, возврат средств, качество работы, другое)
   - Тема
   - Описание
   - Заказ (если применимо)
5. Отправьте претензию

### Шаг 2: Проверка в админ-панели

1. Войдите в систему как администратор
2. Откройте админ-панель
3. Перейдите в раздел "Новые обращения" (New Claims)
4. Проверьте, что созданная претензия отображается в списке

**Что должно быть видно:**
- ID претензии
- Имя пользователя (эксперта)
- Тип претензии
- Тема
- Дата создания
- Статус "Новое"

### Шаг 3: Взятие претензии в работу

1. В списке новых претензий найдите нужную
2. Нажмите кнопку "Взять в работу"
3. Претензия должна переместиться в раздел "Обращения в работе" (In Progress Claims)
4. Проверьте, что ваше имя указано как администратор

### Шаг 4: Завершение претензии

1. В разделе "Обращения в работе" найдите претензию
2. Нажмите кнопку "Завершить"
3. Введите решение/комментарий
4. Претензия должна переместиться в раздел "Завершенные обращения" (Completed Claims)

## Проверка через Django Admin

Если фронтенд не работает, можно проверить через Django Admin:

1. Откройте http://localhost:8000/admin/
2. Войдите как суперпользователь
3. Перейдите в раздел "Claims" (Обращения)
4. Проверьте список претензий

## Проверка через API напрямую

### Получить все претензии
```bash
curl -X GET http://localhost:8000/api/admin-panel/claims/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Получить новые претензии
```bash
curl -X GET "http://localhost:8000/api/admin-panel/claims/?status=new" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Взять претензию в работу
```bash
curl -X POST http://localhost:8000/api/admin-panel/claims/1/take_in_work/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Завершить претензию
```bash
curl -X POST http://localhost:8000/api/admin-panel/claims/1/complete_claim/ \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"resolution": "Проблема решена"}'
```

## Проверка статистики

```bash
curl -X GET http://localhost:8000/api/admin-panel/stats/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

Должно вернуть:
```json
{
  "total_users": 10,
  "active_users": 8,
  "blocked_users": 2,
  "total_orders": 15,
  "active_orders": 5,
  "problem_orders": 2,
  "open_support_requests": 3,
  "new_claims": 2
}
```

## Что проверять

### ✅ Претензия создается
- Претензия сохраняется в БД
- Все поля заполнены корректно
- Статус "new"

### ✅ Претензия видна администратору
- Отображается в списке новых претензий
- Все данные корректны
- Можно открыть детали

### ✅ Администратор может взять в работу
- Статус меняется на "in_progress"
- Администратор назначается
- Претензия перемещается в соответствующий раздел

### ✅ Администратор может завершить
- Статус меняется на "completed"
- Решение сохраняется
- Дата завершения фиксируется

### ✅ Фильтрация работает
- Можно фильтровать по статусу
- Можно фильтровать по типу
- Поиск работает

## Возможные проблемы

### Претензия не отображается в админ-панели

**Причины:**
1. Неправильные права доступа (пользователь не администратор)
2. Проблема с API эндпоинтом
3. Проблема с фронтендом (не загружаются данные)

**Решение:**
```bash
# Проверить права пользователя
python manage.py shell
>>> from django.contrib.auth import get_user_model
>>> User = get_user_model()
>>> admin = User.objects.get(username='admin_username')
>>> print(admin.role)  # Должно быть 'admin'
```

### API возвращает 403 Forbidden

**Причина:** Пользователь не является администратором

**Решение:**
```python
# Изменить роль пользователя
user.role = 'admin'
user.save()
```

### Претензия создается, но не сохраняется

**Причина:** Ошибка валидации

**Решение:** Проверить логи Django:
```bash
# В консоли где запущен сервер
# Должны быть видны ошибки валидации
```

## Дополнительные скрипты

### Создать тестовую претензию
```bash
python test_claims_creation.py --create
```

### Посмотреть все претензии
```bash
python test_claims_creation.py
```

## Логирование

Для отладки можно добавить логирование в views.py:

```python
import logging
logger = logging.getLogger(__name__)

class ClaimViewSet(viewsets.ModelViewSet):
    def get_queryset(self):
        queryset = super().get_queryset()
        logger.info(f"Claims queryset: {queryset.count()} claims")
        return queryset
```

## Заключение

После выполнения всех тестов вы должны убедиться, что:
1. Претензии создаются корректно
2. Претензии видны администратору
3. Администратор может обрабатывать претензии
4. Все статусы меняются правильно
5. API работает корректно
