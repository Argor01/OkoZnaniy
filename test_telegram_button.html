<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Telegram –∫–Ω–æ–ø–∫–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        h2 { margin-top: 0; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
        #telegram-button-container { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üîç –¢–µ—Å—Ç Telegram Login Button</h1>
    
    <div class="test-section info">
        <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <p><strong>Bot Username:</strong> @oko_expert_bot</p>
        <p><strong>–¢–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω:</strong> <span id="current-domain"></span></p>
        <p><strong>–ü—Ä–æ—Ç–æ–∫–æ–ª:</strong> <span id="protocol"></span></p>
    </div>

    <div class="test-section">
        <h2>1. Telegram Login Button</h2>
        <p>–ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è - –¥–æ–º–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ BotFather</p>
        <div id="telegram-button-container"></div>
    </div>

    <div class="test-section" id="callback-section" style="display: none;">
        <h2>2. Callback –¥–∞–Ω–Ω—ã–µ</h2>
        <pre id="callback-data"></pre>
    </div>

    <div class="test-section">
        <h2>3. –ö–æ–Ω—Å–æ–ª—å</h2>
        <p>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ª–æ–≥–æ–≤</p>
        <div id="console-log"></div>
    </div>

    <div class="test-section info">
        <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h2>
        <ol>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://t.me/BotFather" target="_blank">@BotFather</a></li>
            <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ: <code>/setdomain</code></li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ: <code>@oko_expert_bot</code></li>
            <li>–í–≤–µ–¥–∏—Ç–µ: <code>localhost</code></li>
            <li>–û–±–Ω–æ–≤–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
        </ol>
    </div>

    <script>
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω
        document.getElementById('current-domain').textContent = window.location.hostname;
        document.getElementById('protocol').textContent = window.location.protocol;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message, type = 'info') {
            console.log(`[TelegramTest] ${message}`);
            const logDiv = document.getElementById('console-log');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
        }

        // Callback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è Telegram
        window.onTelegramAuth = function(user) {
            log('‚úÖ Telegram callback received!', 'success');
            log(JSON.stringify(user, null, 2));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            document.getElementById('callback-section').style.display = 'block';
            document.getElementById('callback-data').textContent = JSON.stringify(user, null, 2);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
            log('Sending data to backend...');
            fetch('http://localhost:8000/api/users/telegram_auth/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(user)
            })
            .then(response => response.json())
            .then(data => {
                log('‚úÖ Backend response received!', 'success');
                log(JSON.stringify(data, null, 2));
                alert('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
            })
            .catch(error => {
                log('‚ùå Backend error: ' + error.message, 'error');
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ backend. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
            });
        };

        // –°–æ–∑–¥–∞–µ–º Telegram Widget
        log('Creating Telegram widget...');
        const script = document.createElement('script');
        script.src = 'https://telegram.org/js/telegram-widget.js?22';
        script.setAttribute('data-telegram-login', 'oko_expert_bot');
        script.setAttribute('data-size', 'large');
        script.setAttribute('data-radius', '8');
        script.setAttribute('data-onauth', 'onTelegramAuth(user)');
        script.setAttribute('data-request-access', 'write');
        script.async = true;

        script.onload = function() {
            log('‚úÖ Telegram widget script loaded', 'success');
        };

        script.onerror = function() {
            log('‚ùå Failed to load Telegram widget script', 'error');
        };

        document.getElementById('telegram-button-container').appendChild(script);
        log('Widget script added to DOM');
    </script>
</body>
</html>
