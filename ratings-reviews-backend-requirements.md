# Требования к бэкенду для системы отзывов и рейтингов

## 1. Рейтинг экспертов (Expert Rating)

### 1.1 Модель ExpertRating
**Расположение:** `apps/orders/models.py` (уже существует)

**Поля:**
- `order` - связь с заказом (ForeignKey to Order)
- `expert` - эксперт, которого оценивают (ForeignKey to User)
- `client` - клиент, который оценивает (ForeignKey to User)
- `rating` - оценка от 1 до 5 (IntegerField)
- `comment` - текстовый отзыв (TextField, optional)
- `created_at` - дата создания отзыва

**Где используется:**
- Профиль пользователя (`UserProfile.tsx`) - отображение отзывов эксперта
- Детали заказа (`OrderDetail.tsx`) - оценка работы эксперта
- Дашборд эксперта (`ExpertDashboard/ReviewsTab`) - список всех отзывов
- Профиль эксперта (`ExpertProfile.tsx`) - публичные отзывы

**API эндпоинты:**
```
POST /api/experts/ratings/ - создать отзыв
GET /api/experts/ratings/?expert={id} - получить отзывы эксперта
GET /api/experts/ratings/{id}/ - получить конкретный отзыв
```

### 1.2 Статистика эксперта (ExpertStatistics)
**Расположение:** `apps/users/models.py` (уже существует)

**Поля:**
- `average_rating` - средний рейтинг (DecimalField)
- `total_orders` - всего заказов
- `completed_orders` - завершенных заказов
- `success_rate` - процент успешности

**Где используется:**
- Профиль пользователя (`UserProfile.tsx`) - блок "Рейтинг и статистика"
- Отклики на заказы (`OrderDetail.tsx`) - рейтинг эксперта в bid
- Дашборд эксперта - общая статистика

**API эндпоинты:**
```
GET /api/experts/{id}/statistics/ - получить статистику эксперта
```

---

## 2. Рейтинг работ в магазине (Shop Work Rating)

### 2.1 Модель Purchase с рейтингом
**Расположение:** `apps/shop/models.py` (уже существует)

**Поля:**
- `rating` - оценка работы от 1 до 5 (PositiveSmallIntegerField, nullable)
- `rated_at` - дата оценки (DateTimeField, nullable)

**Где используется:**
- Детали работы в магазине (`ShopWorkDetail.tsx`) - средний рейтинг работы
- Карточки работ (`ShopReadyWorks/WorkCard`) - рейтинг на карточке
- Купленные работы (`PurchasedWorks`) - рейтинг купленной работы

**API эндпоинты:**
```
POST /api/shop/purchases/{id}/rate/ - оценить купленную работу
  Body: { "rating": 1-5 }
```

### 2.2 Агрегированный рейтинг работы
**Расположение:** `apps/shop/views.py` (уже реализовано)

**Вычисляемые поля в Work:**
- `rating_avg` - средний рейтинг (Avg('purchase__rating'))
- `rating_count` - количество оценок (Count('purchase__rating'))

**Где используется:**
- Список работ в магазине - сортировка по рейтингу
- Детали работы - отображение среднего рейтинга
- Фильтрация работ по рейтингу

---

## 3. Оценка выполненных заказов

### 3.1 Оценка через чат (MessageModalNew)
**Расположение:** `frontend-react/src/pages/ExpertDashboard/modals/MessageModalNew.tsx`

**Функционал:**
- Клиент может оценить работу при приемке (acceptWorkDelivery)
- Оценка от 1 до 5 звезд
- Опциональный комментарий

**API эндпоинт:**
```
POST /api/chat/chats/{chatId}/accept_work_delivery/
  Body: {
    "message_id": number,
    "rating": 1-5 (optional)
  }
```

**Где используется:**
- Модальное окно чата - кнопка "Принять работу"
- Создает ExpertRating при приемке работы

---

## 4. Отзывы клиентов на лендинге

### 4.1 Статические отзывы
**Расположение:** `frontend-react/src/components/landing/sections/Reviews.tsx`

**Структура:**
- `author` - имя автора
- `workType` - тип работы
- `text` - текст отзыва
- `rating` - оценка (всегда 5)

**Примечание:** Это статические данные для маркетинга, не связаны с реальными отзывами

---

## 5. Админ-панель - оценки удовлетворенности

### 5.1 Оценка завершенных запросов
**Расположение:** `AdminDashboard/CompletedRequestsSection.tsx`

**Поля:**
- `satisfaction_rating` - оценка удовлетворенности (1-5)
- `satisfaction_comment` - комментарий

**Где используется:**
- Таблица завершенных запросов
- Детали запроса в модальном окне

### 5.2 Оценка завершенных обращений (Claims)
**Расположение:** `AdminDashboard/CompletedClaimsSection.tsx`

**Поля:**
- `user_satisfaction_rating` - оценка пользователя (1-5)

**Где используется:**
- Детали завершенного обращения

---

## 6. Рейтинг в откликах на заказы (Bids)

### 6.1 Отображение рейтинга эксперта в откликах
**Расположение:** `OrderDetail.tsx`, `apps/orders/serializers.py`

**Поля в BidSerializer:**
- `expert_rating` - средний рейтинг эксперта (SerializerMethodField)

**Источник данных:**
```python
def get_expert_rating(self, obj):
    return obj.expert.statistics.average_rating
```

**Где используется:**
- Список откликов на заказ - показывает рейтинг каждого эксперта
- Помогает клиенту выбрать исполнителя

---

## 7. Необходимые API эндпоинты

### 7.1 Эксперты - отзывы и рейтинги
```
# Создать отзыв эксперту
POST /api/experts/ratings/
Body: {
  "order": number,
  "rating": 1-5,
  "comment": string (optional)
}

# Получить отзывы эксперта
GET /api/experts/ratings/?expert={expertId}
Response: [
  {
    "id": number,
    "client": { "id", "username", "avatar", "first_name", "last_name" },
    "order": { "id", "title" },
    "rating": number,
    "comment": string,
    "created_at": datetime
  }
]

# Получить статистику эксперта
GET /api/experts/{expertId}/statistics/
Response: {
  "average_rating": number,
  "total_orders": number,
  "completed_orders": number,
  "success_rate": number
}
```

### 7.2 Магазин - рейтинг работ
```
# Оценить купленную работу
POST /api/shop/purchases/{purchaseId}/rate/
Body: {
  "rating": 1-5
}

# Получить работы с рейтингами
GET /api/shop/works/
Response: [
  {
    "id": number,
    "title": string,
    "rating": number, // средний рейтинг (rating_avg)
    "reviewsCount": number, // количество оценок (rating_count)
    ...
  }
]
```

### 7.3 Чат - приемка работы с оценкой
```
# Принять работу с оценкой
POST /api/chat/chats/{chatId}/accept_work_delivery/
Body: {
  "message_id": number,
  "rating": 1-5 (optional)
}
```

---

## 8. Бизнес-логика

### 8.1 Создание отзыва эксперту
**Условия:**
- Только клиент может оставить отзыв эксперту
- Отзыв можно оставить только после завершения заказа
- Один отзыв на один заказ
- Рейтинг от 1 до 5

**Триггеры:**
- При приемке работы через чат (если указан rating)
- Вручную через форму отзыва

**Последствия:**
- Пересчет average_rating эксперта
- Обновление ExpertStatistics
- Уведомление эксперту о новом отзыве

### 8.2 Оценка работы в магазине
**Условия:**
- Только покупатель может оценить работу
- Оценка возможна только после покупки
- Можно изменить оценку

**Последствия:**
- Пересчет rating_avg для работы
- Обновление rating_count

### 8.3 Расчет среднего рейтинга эксперта
**Формула:**
```python
average_rating = ExpertRating.objects.filter(
    expert=expert
).aggregate(Avg('rating'))['rating__avg']
```

**Обновление:**
- При создании нового отзыва
- При изменении существующего отзыва
- Через celery task (периодически)

---

## 9. Права доступа

### 9.1 Создание отзыва эксперту
- Только клиент заказа
- Только после завершения заказа
- Только один раз на заказ

### 9.2 Просмотр отзывов
- Публичные - все пользователи
- Детали заказа - только участники заказа

### 9.3 Оценка работы в магазине
- Только покупатель работы
- После получения файла

---

## 10. Валидация

### 10.1 Рейтинг
- Обязательное поле при создании отзыва
- Значение от 1 до 5 (целое число)
- Не может быть null при создании

### 10.2 Комментарий
- Опциональное поле
- Минимум 10 символов (если указан)
- Максимум 1000 символов

### 10.3 Уникальность
- Один отзыв на один заказ (unique_together: order, client)
- Одна оценка на одну покупку (уже есть в Purchase)

---

## 11. Миграции и модели

### 11.1 Существующие модели
✅ `apps/orders/models.py` - ExpertRating (нужно проверить)
✅ `apps/shop/models.py` - Purchase.rating, Purchase.rated_at
✅ `apps/users/models.py` - ExpertStatistics

### 11.2 Необходимые изменения
- [ ] Проверить наличие модели ExpertRating
- [ ] Добавить unique_together для ExpertRating
- [ ] Добавить индексы для быстрого поиска
- [ ] Добавить сигналы для автоматического пересчета рейтингов

---

## 12. Уведомления

### 12.1 Эксперту
- Новый отзыв получен
- Изменение среднего рейтинга

### 12.2 Клиенту
- Напоминание оценить работу (через N дней после завершения)

---

## 13. Приоритеты реализации

### Высокий приоритет
1. ✅ Оценка работ в магазине (уже реализовано)
2. Создание отзывов экспертам (ExpertRating API)
3. Расчет среднего рейтинга эксперта
4. Отображение отзывов в профиле эксперта

### Средний приоритет
5. Оценка при приемке работы через чат
6. Уведомления о новых отзывах
7. Валидация и права доступа

### Низкий приоритет
8. Админ-панель для модерации отзывов
9. Статистика по рейтингам
10. Экспорт отзывов

---

## 14. Тестирование

### 14.1 Unit-тесты
- Создание отзыва
- Расчет среднего рейтинга
- Валидация данных
- Права доступа

### 14.2 Integration-тесты
- Полный цикл: заказ → выполнение → отзыв
- Покупка работы → оценка
- Пересчет статистики

### 14.3 E2E-тесты
- Клиент оставляет отзыв эксперту
- Покупатель оценивает работу
- Отображение рейтингов в UI
